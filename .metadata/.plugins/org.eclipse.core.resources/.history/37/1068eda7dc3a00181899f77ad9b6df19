package com.dr.controller.task;

import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.apache.log4j.Logger;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Component;

import com.dr.common.PropertyUtil;
import com.dr.common.Utils;
import com.dr.model.member.DrMemberMsg;
import com.dr.model.system.SysMessageLog;
import com.dr.service.activity.DrMemberFavourableService;
import com.dr.service.subject.DrSubjectInfoService;

@Component
public class SubjectTask {
	private Logger log = Logger.getLogger(this.getClass());
	
	@Autowired
	public DrSubjectInfoService drSubjectInfoService;
	@Autowired
	public DrMemberFavourableService drMemberFavourableService;
	
	/**
	 * 每天0点把到期的标的状态修改为已到期
	 */
//	@Scheduled(cron="0 0 0 * * ?") //定义每天0点触发一次
	//@Scheduled(cron="0 0,23 0,19 22 3 ?")
	
   	public void queryPayResult() {
    	try {
    		drSubjectInfoService.updateDrSubjectInfoByExpire();
		} catch (Exception e) {
			e.printStackTrace();
		}
   	}
	/**
	 * 红包过期短信提醒
	 */
//	@Scheduled(cron="0 0 1 * * ?")//凌晨
	//@Scheduled(cron="0 0,50 0,16 11 4 ?")
	public void redEnvelopExpire(){
		Date now = new Date();
		Date threeDayAft = Utils.getDayNumOfAppointDate(now, -3);
		Map<String,Object> param = new HashMap<String,Object>();
		param.put("startDate",now);
		param.put("endDate", threeDayAft);
		log.info(now+"红包过期提醒短信开始"); 
		try {
			drMemberFavourableService.getRedEnvelopExpire(param);
		} catch (Exception e) {
			log.error("红包过期提醒短信异常",e);
		}
		log.info(now+"红包过期提醒短信任务结束");
	}
	/**
	 * 优惠券过期任务
	 */
//	@Scheduled(cron="0 0,15 0 * * ?")yx
	//@Scheduled(cron="0 0,40 0,16 11 4 ?")
	public void expireFavourable(){
		log.info("优惠券过期任务任务开始");
		try {
			drMemberFavourableService.expireFavourable();
		} catch (Exception e) {
			log.error("优惠券过期任务异常",e);
		}
		log.info("优惠券过期任务任务结束");
	}
}